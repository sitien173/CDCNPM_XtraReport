/**
* DevExpress Analytics (widgets\treelist\_binding.js)
* Version:  21.2.7
* Build date: Apr 13, 2022
* Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED
* License: https://www.devexpress.com/Support/EULAs/universal.xml
*/
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var ko = require("knockout");
var $ = require("jquery");
var _treelistItem_1 = require("./_treelistItem");
var _treelistController_1 = require("./_treelistController");
var _treeListSearchViewModel_1 = require("./_treeListSearchViewModel");
var scroll_view_1 = require("devextreme/ui/scroll_view");
var _utils_1 = require("../../serializer/_utils");
var templateUtils_1 = require("../../property-grid/widgets/templateUtils");
ko.bindingHandlers['treelist'] = {
    init: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
        var treeListViewModel = null;
        var childContext = null;
        var callback = null;
        var values = valueAccessor(), options = ko.unwrap(values), pathArray, updateScrollBar = function () {
            var options = ko.unwrap(values);
            var scrollViewElt = $(element).closest('.dx-scrollview').get(0);
            var scrollView = scrollViewElt && scroll_view_1.default.getInstance(scrollViewElt);
            scrollView && scrollView['update']();
            if (options.onItemsVisibilityChanged) {
                options.onItemsVisibilityChanged();
            }
        }, updateTreeList = function (options) {
            pathArray && pathArray.dispose();
            var treeListController = options.treeListController || new _treelistController_1.TreeListController();
            options.treeListController = treeListController;
            treeListController.dragDropHandler = treeListController.dragDropHandler || bindingContext.$root.fieldDragHandler;
            options.factory = options.factory || new _treelistItem_1.DefaultTreeListItemFactory();
            options.itemsProvider = ko.unwrap(options.itemsProvider);
            options.pageSize = options.pageSize || -1;
            treeListViewModel && treeListViewModel.dispose();
            if (!options || !options.itemsProvider)
                return;
            if (!options.rtl) {
                options.rtl = $(element).closest('.dx-rtl').length > 0;
            }
            pathArray = ko.computed(function () {
                var result = ko.unwrap(options.path);
                if (!Array.isArray(result)) {
                    return !!result ? result.split('.') : [];
                }
                return result;
            });
            treeListViewModel = options.factory.createRootItem(options, pathArray, updateScrollBar, options.rtl);
            var treeListTemplate = options.templateHtml || templateUtils_1.getTemplate('dx-treelist');
            if (treeListController.root) {
                treeListController.searchEnabled = true;
                treeListController.searchOptions = treeListController.searchOptions || new _treeListSearchViewModel_1.TreeListSearchOptions();
                treeListController.root(treeListViewModel);
            }
            var $element = $(element).html(treeListTemplate);
            childContext = bindingContext.createChildContext(treeListViewModel);
            ko.applyBindings(childContext, $element.children()[0]);
            callback && ko.utils.domNodeDisposal.removeDisposeCallback(element, callback);
            callback = function () {
                treeListViewModel && treeListViewModel.dispose();
                treeListViewModel = null;
                subscription && subscription.dispose();
                pathArray && pathArray.dispose();
                callback = null;
                ko.utils.domNodeDisposal.removeDisposeCallback(element, callback);
            };
            ko.utils.domNodeDisposal.addDisposeCallback(element, callback);
        };
        updateTreeList(_utils_1.extend({}, options));
        var subscription = null;
        if (ko.isSubscribable(values)) {
            subscription = values.subscribe(function (newValue) {
                newValue && updateTreeList(_utils_1.extend({}, newValue));
            });
        }
        else if (ko.isSubscribable(values.itemsProvider)) {
            subscription = values.itemsProvider.subscribe(function (newValue) {
                newValue && updateTreeList(_utils_1.extend({}, values));
            });
        }
        return { controlsDescendantBindings: true };
    }
};
ko.bindingHandlers['treeListSearchPanel'] = {
    init: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
        var values = valueAccessor();
        var template = ko.unwrap(values.template);
        var modelType = ko.unwrap(values.modelType);
        var controllers = ko.unwrap(values.controllers);
        if (!Array.isArray(controllers))
            controllers = [controllers];
        _treeListSearchViewModel_1.TreeListSearchViewModel.createController(element, controllers, modelType, template);
        return { controlsDescendantBindings: true };
    }
};
